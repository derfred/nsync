<html>
  <head>
    <link rel="stylesheet" href="style.css" type="text/css" media="screen" charset="utf-8">

    <script src="external/raphael.js" type="text/javascript" charset="utf-8"></script>
    <script src="base.js" type="text/javascript" charset="utf-8"></script>
    <script src="ui.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
      function NetworkForm() {
        NetworkForm.update_initial_phases_form();
      }

      NetworkForm.build_initial_phases_form = function(total) {
        var html = "<a href='#' id='randomize_phases'>Randomize</a><table>";

        html += "<tr><th></th>";
        for (var i=0; i < total; i++) {
          html += ("<th><input type='text' id='phase" + i + "' value='" + Math.random() + "'></th>");
        };
        html += "</tr>";

        for (var i=0; i < total; i++) {
          html += "<tr>";
          html += ("<td>Neuron " + i + "</td>");
          for(var j=0;j < total; j++) {
            if(i==j) {
              html += ("<td class='radio'><input type='radio' name='neuron" + i + "' value='" + j + "' checked></td>");
            } else {
              html += ("<td class='radio'><input type='radio' name='neuron" + i + "' value='" + j + "'></td>");
            }
          }
          html += "</tr>";
        };

        return html + "</table>";
      }

      NetworkForm.update_initial_phases_form = function() {
        $("initial_phase_holder").innerHTML = NetworkForm.build_initial_phases_form($F("init_n"));
        $("randomize_phases").onclick = NetworkForm.update_initial_phases_form;

        if(!$("toggle_initial_phase_holder").onclick) {
          $("toggle_initial_phase_holder").onclick = function(e) {
            if($("initial_phase_holder").style.display == "none") {
              $("initial_phase_holder").style.display = "block";
              e.currentTarget.innerHTML = "-";
            } else {
              $("initial_phase_holder").style.display = "none";
              e.currentTarget.innerHTML = "+";
            }
            return false;
          }
        }

        return false;
      }

      NetworkForm.prototype.C = function() {
        return $F("init_c");
      }

      NetworkForm.prototype.gamma = function() {
        return $F("init_gamma");
      }

      NetworkForm.prototype.n = function() {
        return $F("init_n");
      }

      NetworkForm.prototype.tau = function() {
        return $F("init_tau");
      }

      NetworkForm.prototype.epsilon = function() {
        return $F("init_epsilon");
      }

      NetworkForm.prototype.getCheckedValue = function(name) {
        radioObj = document.getElementsByName(name);
        if(!radioObj) {
          return "";
        }

        var radioLength = radioObj.length;
        if(radioLength == undefined) {
          if(radioObj.checked) {
            return radioObj.value;
          } else {
            return "";
          }
        }

        for(var i = 0; i < radioLength; i++) {
          if(radioObj[i].checked) {
            return radioObj[i].value;
          }
        }
        return "";
      }

      NetworkForm.prototype.initial_phases = function() {
        var result = [];
        for(var i=0;i<this.n();i++) {
          result.push($F("phase"+this.getCheckedValue("neuron"+i)));
        }
        return result;
      }


      function generate_network() {
        return Network.fully_connected(network_form.n(), {
          delay: network_form.tau(),
          strength: network_form.epsilon(),
          C: network_form.C(),
          gamma: network_form.gamma(),
          initial_phases: network_form.initial_phases()
        });
      }


      var simulator = false;
      var drawer = false;
      var network_form = false;
      window.onload = function() {
        $("init_controls").onsubmit = function() {
          if(simulator) {
            simulator.stop(function() {
              var network = generate_network();
              simulator.initialize(network, drawer);
              simulator.run();
            });
          }
          return false;
        };
        network_form = new NetworkForm();

        var network = generate_network();
        var drawer = new Drawer();

        simulator = new Simulator();
        simulator.initialize(network, drawer);

        drawer.neuron_click(function(neuron_id) {
          simulator.perturb_neuron(neuron_id, $F("pertubation_amount"));
        });

        simulator.run();
      }
    </script>
  </head>
  <body>
    <form id="init_controls" class="section">
      <h2>Network Parameters</h2>
      <p><label>Driving Current (C)</label><input type="text" value="1.04" id="init_c"></p>
      <p><label>Leak Constant (&gamma;)</label><input type="text" value="1.0" id="init_gamma"></p>
      <p><label>Number of Neurons (N)</label><input type="text" value="5" id="init_n"></p>
      <p><label>Connection Strength (&epsilon;)</label><input type="text" value="0.025" id="init_epsilon"></p>
      <p><label>Signal delay (&tau;)</label><input type="text" value="0.31" id="init_tau"></p>

      <h3><a href="#" id="toggle_initial_phase_holder" class="">+</a>Initial Phases</h3>
      <div id="initial_phase_holder" style="display: none;">
        
      </div>

      <input type="submit" value="Generate Network">
    </form>
    <div id="network_holder" class="section">
      <h2>Network</h2>
      <div id="network">

      </div>
      <div id="graph_holder">
        <ul>
          <li><a href="#" id="phases_link" class="tab_switcher">Phases</a></li>
          <li class="active"><a href="#" id="spikes_link" class="tab_switcher">Spikes</a></li>
          <li><a href="#" id="phase_differences_link" class="tab_switcher">Phase Difference</a></li>
        </ul>
        <div id="phases" class="tab" style="display: none;">
          <canvas id="phases_canvas" width="600" height="320"></canvas>
        </div>
        <div id="spikes" class="tab">
          <canvas id="spikes_canvas" width="600" height="320"></canvas>
        </div>
        <div id="phase_differences" class="tab" style="display: none;">
          <canvas id="phase_differences_canvas" width="600" height="320"></canvas>
        </div>
      </div>
    </div>
    <form id="controls" class="section">
      <h2>Interaction Parameters</h2>
      <p><label>Phase Shift for Pertubations</label><input type="text" value="0.5" id="pertubation_amount"></p>
    </div>
  </body>
</html>
